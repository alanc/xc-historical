#define IHaveSubdirs
#define PassCDebugFlags 'CDEBUGFLAGS=$(CDEBUGFLAGS)'

    CDEBUGFLAGS = -g
     ALLDDXDIRS = ddx/mi ddx/sun ddx/cfb ddx/apollo ddx/mfb ddx/lk201 \
                    ddx/qvss ddx/ibm/apa16 ddx/ibm/rt
      ALLOSDIRS = os/sysV os/4.2bsd
        SUBDIRS = dix $(ALLDDXDIRS) $(ALLOSDIRS)
           UNIX = os/4.2bsd/libos.a
           SYSV = os/sysV/libos.a
            MFB = ddx/mfb/libmfb.a
            CFB = ddx/cfb/libcfb.a
             MI = ddx/mi/libmi.a
            DIX = dix/libdix.a
            SUN = ddx/sun/libsun.a
     EXTENSIONS =
        SYSLIBS = -lm -ldbm
            ALL = Xqvss Xsun Xapa16 Xapollo


#ifdef XServerName
all: XServerName

install:: XServerName
	  $(INSTALL) -c $(INSTALLFLAGS) XServerName $(BINDIR)
#else XServerName
all: servertype
	@(s=`cat servertype`; \
	  set -x; \
	  $(MAKE) $(MFLAGS) 'CDEBUGFLAGS=$(CDEBUGFLAGS)' $$s)

servertype:
	@echo "For the server, you must either supply a specific"; \
	echo "target ($(ALL)) or put the name of that target in"; \
	echo "the file server/$@"

install:: servertype
	@(s=`cat servertype`; \
	  set -x; \
	  $(INSTALL) -c $(INSTALLFLAGS) $$s $(BINDIR))
#endif XServerName

#
# qvss server
#
QVSSDIRS = ddx/mi ddx/mfb ddx/lk201 ddx/qvss os/4.2bsd
QVSSOBJS = ddx/qvss/init.o ddx/qvss/qvss_io.o ddx/lk201/lk201.o
QVSSLIBS = $(DIX) $(UNIX) $(MFB) $(MI) $(EXTENSIONS)
#ifdef XQvssServer
SERVERDIRS = $(QVSSDIRS)
#endif

ServerTarget(Xqvss,dix $(QVSSDIRS),$(QVSSOBJS),$(QVSSLIBS),$(SYSLIBS))


#
# sun server
#
SUNDIRS = ddx/mi ddx/mfb ddx/cfb ddx/sun os/4.2bsd
SUNOBJS = ddx/sun/sunInit.o
SUNLIBS = $(SUN) $(CFB) $(DIX) $(UNIX) $(MFB) $(MI) $(EXTENSIONS)
SUNSYSLIBS = $(SYSLIBS) $(SUNWINDOWSLIBS)
#ifdef XSunServer
SERVERDIRS = $(SUNDIRS)
#endif

ServerTarget(Xsun,dix $(SUNDIRS),$(SUNOBJS),$(SUNLIBS),$(SUNSYSLIBS))


#
# apa16 server
#
APA16DIRS = ddx/mi ddx/mfb ddx/ibm/apa16 ddx/ibm/rt os/4.2bsd
APA16OBJS = ddx/ibm/rt/rtinit.o ddx/ibm/rt/rtio.o
APA16LIBS = ddx/ibm/rt/librt.a ddx/ibm/apa16/libapa16.a \
		$(DIX) $(UNIX) $(MFB) $(MI) $(EXTENSIONS)
#ifdef XApa16Server
SERVERDIRS = $(APA16DIRS)
#endif

ServerTarget(Xapa16,dix $(APA16DIRS),$(APA16OBJS),$(APA16LIBS),$(SYSLIBS))


#
# apollo server
#
APOLLODIRS = ddx/mi ddx/mfb ddx/apollo os/4.2bsd
APOLLOOBJS = ddx/apollo/init.o ddx/apollo/apollo_io.o \
		ddx/apollo/gpr_type_mgr.o /sys/traits/io_traits
APOLLOLIBS = $(DIX) $(UNIX) $(MFB) $(MI) $(EXTENSIONS)
#ifdef XApolloServer
SERVERDIRS = $(APA16DIRS)
#endif

ServerTarget(Xapollo,dix $(APOLLODIRS),$(APOLLOOBJS),$(APOLLOLIBS),$(SYSLIBS))

#
# other, necessary targets
#
DependSubdirs($(SERVERDIRS))

$(SUBDIRS): FRC
	@cd $@ ; echo "making $@"; \
	$(MAKE) $(MFLAGS) PassCDebugFlags all
FRC:

lint:
	lint dix/?*.ln os/4.2bsd/?*.ln ddx/mi/?*.ln ddx/mfb/?*.ln > lint.out

lintlibs:
	echo "This will take a while"
	for i in dix $(SERVERDIRS); do \
		(cd $$i ; echo " -- making lintlib in $$i"; \
		$(MAKE) $(MFLAGS) lint) \
	done
