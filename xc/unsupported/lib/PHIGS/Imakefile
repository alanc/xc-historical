##
# $XConsortium: Imakefile,v 5.16 91/05/06 19:21:55 rws Exp $
##
## 
## Copyright 1989, 1990, 1991 by Sun Microsystems, Inc. and the X Consortium.
## 
##			 All Rights Reserved
## 
## Permission to use, copy, modify, and distribute this software and its 
## documentation for any purpose and without fee is hereby granted, 
## provided that the above copyright notice appear in all copies and that
## both that copyright notice and this permission notice appear in 
## supporting documentation, and that the names of Sun Microsystems,
## the X Consortium, and MIT not be used in advertising or publicity 
## pertaining to distribution of the software without specific, written 
## prior permission.  
## 
## SUN MICROSYSTEMS DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, 
## INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO
## EVENT SHALL SUN MICROSYSTEMS BE LIABLE FOR ANY SPECIAL, INDIRECT OR
## CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF
## USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
## OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
## PERFORMANCE OF THIS SOFTWARE.

#include <Library.tmpl>

#define IHaveSubdirs
#define PassCDebugFlags 'CDEBUGFLAGS=$(CDEBUGFLAGS)'

#ifndef PexPhigsCDebugFlags
#define PexPhigsCDebugFlags LibraryCDebugFlags
#endif

  CCOPTIONS = PexCCOptions
CDEBUGFLAGS = PexPhigsCDebugFlags
    DEFINES = PexPhigsDefines

.SUFFIXES: .o

#if HasLargeTmp | SystemV4
     ARADD = ar ru
     AREXT = ar x
#else
     ARADD = ar rul
     AREXT = ar xl
#endif
     LIBDIRS = archive c_binding css cp error input pex util ws ws_type
     SUBDIRS = include $(LIBDIRS)

     ALL_OBJ = archive/ar*.o c_binding/cb*.o \
		cp/cp*.o cp/psl.o css/css*.o \
		error/er*.o input/sin*.o pex/pex*.o  util/ut*.o \
		ws/ws*.o ws_type/wstx*.o
     ALL_DONE = archive/DONE c_binding/DONE cp/DONE css/DONE \
		error/DONE input/DONE pex/DONE util/DONE \
		ws/DONE ws_type/DONE

   PEXAPIINC = include
  PEXINCLUDE = ../../include/PEX
    XINCLUDE = $(SERVERSRC)/include
    INCLUDES = -I. -I$(PEXAPIINC) -I$(PEXINCLUDE) -I$(XINCLUDE) \
		-I$(INCLUDESRC)

    SWAPDIR = ../../server/PEX/dipex/swap
    SWAPLIB  = $(SWAPDIR)/libdiswapex.a
   SWAPOBJS  = OCTables.o Convert.o floatconv.o OCattr.o OCcolour.o   \
		cOCprim.o uOCprim.o

    LINTLIBS =

all:: include libphigs.a phigsmon lib lib/PHIGSerr.txt lib/PHIGSfnc.txt lib/phigsmon

libphigs.a: $(LIBDIRS) $(ALL_DONE) $(SWAPDIR) $(SWAPLIB)
	$(RM) $@
	$(AREXT) $(SWAPLIB) $(SWAPOBJS)
	$(AR) $@ $(SWAPOBJS)
	$(RM) $(SWAPOBJS)
	$(ARADD) $@ $(ALL_OBJ)
	RanLibrary($@)

lib:
	-mkdir $@

phigsmon:
	@cd cp ; echo "making phigsmon in $(CURRENT_DIR)/cp..."; \
	$(MAKE) $(MFLAGS) PassCDebugFlags phigsmon

lib/phigsmon: cp/phigsmon
	$(RM) $@
	cd lib; $(LN) ../cp/phigsmon phigsmon

lib/PHIGSerr.txt: include/PHIGSerr.txt
	$(RM) $@
	cd lib; $(LN) ../include/PHIGSerr.txt PHIGSerr.txt

include/PHIGSerr.txt:
	cd include; $(MAKE) $(MFLAGS) PHIGSerr.txt

lib/PHIGSfnc.txt: include/PHIGSfnc.txt
	$(RM) $@
	cd lib; $(LN) ../include/PHIGSfnc.txt PHIGSfnc.txt

lintlib lint-library: FRC
	(cd c_binding; $(MAKE) $(MFLAGS) lint-library)

lintlibs:
	-for i in ${SUBDIRS}; do \
	    ( 	echo in $$i; cd $$i; \
		$(MAKE) $(MFLAGS) lintlib  \
	    ); done

lint lint-x: lintlibs
	-for i in ${SUBDIRS}; do \
	    ( 	echo in $$i; cd $$i; \
		$(MAKE) $(MFLAGS) $@  \
	    ); done

extract: FRC
	for i in  $(SUBDIRS) ;\
	do \
	(cd $$i ; echo "making $@ in $$i"; \
	$(MAKE) $@); \
	done

$(SUBDIRS) $(SWAPDIR): FRC
	@cd $@ ; echo "making all in $(CURRENT_DIR)/$@..."; \
	$(MAKE) $(MFLAGS) PassCDebugFlags all

InstallLibrary(phigs,$(USRLIBDIR))
InstallProgram(lib/phigsmon,$(PEXAPIDIR))
InstallNonExecFile(lib/PHIGSerr.txt,$(PEXAPIDIR))
InstallNonExecFile(lib/PHIGSfnc.txt,$(PEXAPIDIR))

#ifdef HPArchitecture
NormalLibraryObjectRule()
SpecialObjectRule(hppex.o, $(IRULESRC)/$(MACROFILE), $(EXT_DEFINES))
#endif

DependSubdirs($(SUBDIRS))

clean::
	$(RM) lib/phigsmon lib/PHIGSerr.txt lib/PHIGSfnc.txt

FRC:
